import { Advisory, toAdvisory } from './advisory'
import { Repository, toRepository } from './repository'
import { RepositoryVulnerabilityAlert, Scalars } from '@octokit/graphql-schema'
import { Vulnerability, toVulnerability } from './vulnerability'

export interface Alert {
  repository: Repository
  packageName: string
  advisory?: Advisory
  vulnerability?: Vulnerability
  manifest: string
  createdAt: string
  dismissedAt: string
  fixedAt: string
}

export const toAlert = (
  repositoryVulnerabilityAlert: RepositoryVulnerabilityAlert & {
    fixedAt: Scalars['DateTime']
  },
): Alert => ({
  repository: toRepository(repositoryVulnerabilityAlert.repository),
  packageName:
    repositoryVulnerabilityAlert.securityVulnerability?.package.name || '',
  advisory: repositoryVulnerabilityAlert.securityAdvisory
    ? toAdvisory(repositoryVulnerabilityAlert.securityAdvisory)
    : undefined,
  vulnerability: repositoryVulnerabilityAlert.securityVulnerability
    ? toVulnerability(repositoryVulnerabilityAlert.securityVulnerability)
    : undefined,
  manifest: repositoryVulnerabilityAlert.vulnerableManifestFilename,
  createdAt: repositoryVulnerabilityAlert.createdAt,
  dismissedAt: repositoryVulnerabilityAlert.dismissedAt,
  fixedAt: repositoryVulnerabilityAlert.fixedAt,
})
